#!/bin/bash
echo -e "\033[0;32mCleaning dist..."
rm -rf dist

echo -e "\033[0;32mCompiling WASM"
mkdir -p dist/bin
pushd wasm
zig build
popd
cp ./wasm/zig-out/bin/peggiator.wasm ./dist/bin/

echo -e "\033[0;32mCompiling typescript..."
./node_modules/.bin/tsc # Compile typescript
./node_modules/.bin/tsc --p server/tsconfig.json

echo -e "\033[0;32mBundling..."
./node_modules/.bin/webpack # Bundle renderer.ts

# Copy html to dist
echo -e "\033[0;32mCopying source..."
cp src/index.html dist/
cp src/styles.css dist/

# Copy shaders
echo -e "\033[0;32mCopying shaders..."
mkdir -p "dist/shaders" "dist/shaders/source"
find "src/renderer/shaders/source" -name \*.glsl -exec cp {} "dist/shaders/source" \;

# Copy auxiliary apps
echo -e "\033[0;32mCopying auxiliary plugins"
cp bin/* ./dist/bin

# Source environment variables
if [ -f .env ]; then
    echo -e "\033[32mSourcing environment...\033[0m"
    source .env
fi
